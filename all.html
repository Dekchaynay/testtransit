<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>BUS TRANSIT</title>
        <style>
        #map {
            min-height: 400px;
            background-color: #000;
            position: fixed;
            top: 0px;
            bottom: 0;
            left: 0;
            right: 0;
            border-top: 1px solid #ccc;
        }

        #realmap {
            width: 100%;
            height: 100%;
        }

        #error {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 5px 20px;
            background-color: rgba(0, 0, 0, 0.74);
            color: white;
            font-size: 14px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://unpkg.com/mqtt@4.1.0/dist/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/geolocator/2.1.1/geolocator.min.js"></script>
    <script>
      var mqttClient = null
      var markers = {}
      var polylines = {}
      var polylineBounds = {}
      var map = null
      var currentStationMarker = null
      var currentEstimateTimeTopic = null
      var stations = [
                      ['24', 'คณะทันตแพทย์',19.0300992510146, 99.9153158271976,
          [-1,1]
        ],
                  ['26', 'คณะวิศวะฯ',19.030743045046, 99.9011293999438,
          [5,1]
        ],
                  ['3', 'ตรงข้ามคณะทันตแพทย์',19.0298811425495, 99.9152105293279,
          [1,-1]
        ],
                  ['5', 'คณะ ICT',19.0285312222507, 99.8997568521875,
          [-1,5]
        ],
                  ['11', 'ตรงข้ามคณะวิศวะฯ',19.0305945510911, 99.9012063175114,
          [1,2]
        ],
                  ['17', 'ตรงข้ามเวียงพะเยา',19.0331767496957, 99.8908889129654,
          [5,3]
        ],
                  ['2', 'ตรงข้ามศูนย์การแพทย์ฯ',19.0303997661891, 99.9207381527999,
          [1,-1]
        ],
                  ['15', 'รร.สาธิตฯ',19.0344520785843, 99.884229524562,
          [5,3]
        ],
                  ['16', 'ตรงข้ามอาคารสงวนเสริมศรี',19.0341699317405, 99.8862808237124,
          [5]
        ],
                  ['10', 'คณะวิทยาศาสตร์',19.0305839956287, 99.8976356537223,
          [1,-1,5,3]
        ],
                  ['4', 'เรือนเอื้องคำ',19.028593639796, 99.9067052811167,
          [1,-1]
        ],
                  ['9', 'คณะศิลปศาสตร์',19.0295079268704, 99.8956936873029,
          [1,-1,5,3]
        ],
                  ['13', 'เวียงพะเยา',19.0330752303305, 99.8909007432316,
          [5,3]
        ],
                  ['25', 'ศูนย์การแพทย์ฯ',19.0306122557762, 99.920776015361,
          [1,-1]
        ],
                  ['14', 'อาคารสงวนเสริมศรี',19.034098948714, 99.8862104462195,
          [5]
        ],
                  ['23', 'ตรงข้ามเรือนเอื้องคำ',19.0287685676092, 99.9068171361753,
          [-1,1]
        ],
                  ['12', 'ตรงข้ามตึกอุบาลีฯ',19.0317632923438, 99.8935795079108,
          [3,5]
        ],
                  ['6', 'หอประชุมฯ',19.0300579758595, 99.8977458941445,
          [1,-1,5,3]
        ],
                  ['27', 'ตึกอุบาลีฯ',19.0318208267928, 99.8936581065512,
          [5,3]
        ],
                  ['22', 'ตรงข้ามคณะ ICT',19.0286093906671, 99.899744612265,
          [-1,2]
        ],
                  ['20', 'ตึกอธิการฯ',19.0290291077182, 99.8960498905044,
          [1,-1,5,3]
        ],
                  ['1', 'หน้า ม.',19.030725359438, 99.9234233115553,
          [1,-1]
        ],
                  ['8', 'อาคารเรียนรวม',19.0255588089724, 99.895118144624,
          [1,-1,5,3]
        ],
                ]
      var comingBus = null
      var busToStation = {}

      function initMap () {
        map = new google.maps.Map(document.getElementById('realmap'), {
          streetViewControl: false,
          mapTypeControl: false,
          center: { lat: 19.0270115, lng: 99.8902704 },
          zoom: 15,
          fullscreenControl: false,
          zoomControl: false,
          styles: [
//            {
//              featureType: '*',
//              elementType: 'labels',
//              stylers: [{visibility: 'off'}]
//            },
//            {
//              featureType: 'poi',
//              stylers: [{visibility: 'off'}]
//            },
//            {
//              featureType: 'administrative',
//              stylers: [{visibility: 'off'}]
//            },
//            {
//              featureType: 'road',
//              elementType: 'labels.text',
//              stylers: [{visibility: 'off'}]
//            },{
//              featureType: 'landscape',
//              stylers: [{visibility: 'off'}]
//            },
//            {
//              featureType:'water',
//              stylers: [{visibility: 'off'}]
//            }
          ]
        })

        currentRoute =
                  1

        var routes =
                  [{"id":11,"name":"\u0e2a\u0e32\u0e22\u0e27\u0e34\u0e28\u0e27\u0e30","number":1,"color":"#00d10e","line":[[19.03071353182,99.923240113211],[19.030534782603,99.921211019165],[19.030244443312,99.919096100283],[19.029384866877,99.91771476264],[19.029343047147,99.91755652425],[19.030183610388,99.91432983061],[19.031083730464,99.911741483164],[19.031117334799,99.911467283426],[19.030977876531,99.911260753332],[19.030463147727,99.911215155779],[19.029905311754,99.911089091955],[19.029731049639,99.910870341267],[19.029705732914,99.910658016349],[19.029868012858,99.909346416141],[19.029779487066,99.909049509277],[19.029391536105,99.908577440491],[19.028678896262,99.907477601257],[19.028600291371,99.907201333728],[19.028691574467,99.906648798671],[19.02883864157,99.906302793708],[19.029008947916,99.906181717653],[19.029566786899,99.905894721289],[19.030479610285,99.905369008322],[19.030849809451,99.904770875712],[19.031042515539,99.904384637613],[19.031209865382,99.904250527163],[19.031262370099,99.90385885762],[19.031225603872,99.903726088274],[19.031100091518,99.903557109106],[19.030818639226,99.903384106624],[19.030747642177,99.903365331161],[19.030624665072,99.90339483546],[19.030548596715,99.903322415817],[19.030523240588,99.903228538501],[19.030537186458,99.903117226827],[19.030587898704,99.903058218229],[19.030638610934,99.903032737243],[19.0306592509,99.90275512861],[19.030657983094,99.902154313791],[19.030642769429,99.900806503761],[19.030660518705,99.89913468264],[19.03053627373,99.898657249436],[19.030419635506,99.898397075161],[19.030409493047,99.898340748772],[19.030323533562,99.898290052771],[19.030295641784,99.898231044172],[19.030258641256,99.898129300482],[19.030248498788,99.898005918868],[19.02990619013,99.897413150675],[19.029612057682,99.896903530963],[19.029432028082,99.896562890418],[19.0289249014,99.895717994578],[19.028832984523,99.895500735648],[19.028832192138,99.895491012638],[19.028830448885,99.895481960185],[19.028828230201,99.895476056805],[19.028825377607,99.895467674902],[19.028822440453,99.895457865272],[19.028820021061,99.895451786992],[19.02881659268,99.895440198311],[19.028814432113,99.895432968223],[19.028809508852,99.895419383913],[19.028806614757,99.895417228373],[19.028804850755,99.89541045091],[19.028802225501,99.895403709417],[19.028800868055,99.89539763848],[19.02879973029,99.895393184503],[19.028797641647,99.895387724701],[19.028797594923,99.895382252577],[19.028796937647,99.895376666669],[19.028794061679,99.89537041021],[19.028793064077,99.895364602806],[19.028792700377,99.895358460125],[19.028790613768,99.895354340345],[19.02879156465,99.895350149405],[19.028791247678,99.895344282061],[19.028789662633,99.895335229549],[19.028790613769,99.895339252919],[19.028789662825,99.895330535799],[19.028788712038,99.895326847702],[19.028788395084,99.895322824388],[19.028788711145,99.895315783343],[19.02878744378,99.895311089649],[19.028788712039,99.895304384202],[19.028789028995,99.89529801395],[19.028788553592,99.895293990639],[19.028789979857,99.895286614568],[19.028789345237,99.895281249976],[19.028791564633,99.895278567941],[19.028795050564,99.895271191635],[19.028799488506,99.895256774992],[19.028804638923,99.895240989147],[19.028807254182,99.895231573462],[19.028809948718,99.895226153188],[19.02881271842,99.895221000016],[19.028816759659,99.895213162305],[19.028820404776,99.895206540313],[19.028824208559,99.89519933154],[19.028827062188,99.895192961132],[19.028831818604,99.895186590605],[19.028835762613,99.895180320751],[19.028842120623,99.895172442366],[19.028847210795,99.8951642287],[19.028853906509,99.895155176036],[19.028858423386,99.89515182316],[19.028863098749,99.895146793979],[19.028868447495,99.895141429543],[19.028870943645,99.895138412023],[19.028886157777,99.895127347646],[19.028896142183,99.895121312445],[19.028905175706,99.895114941905],[19.028918804757,99.895104883621],[19.028929936401,99.895101195733],[19.028943920937,99.895093819551],[19.028956359074,99.895090131473],[19.028964599893,99.895086108159],[19.028977278076,99.895082084845],[19.028987737566,99.895080576118],[19.029002000531,99.895078061538],[19.029018482165,99.895079402636],[19.029033009584,99.895082084849],[19.029048804833,99.895082755397],[19.029101419259,99.895097507547],[19.029176220462,99.895140422891],[19.029234540021,99.895241005729],[19.029270038873,99.895314766477],[19.029362589416,99.895346952986],[19.029485567455,99.895663453649],[19.029722648571,99.896085901569],[19.029895538087,99.896365063075],[19.030018515731,99.896630601767],[19.030523177029,99.897543193559],[19.030609387844,99.897815437774],[19.030726025936,99.897922726135],[19.030755185446,99.898044766645],[19.030760256664,99.898145349483],[19.030699402031,99.898270072202],[19.030601781009,99.898338468532],[19.030556139993,99.898342491846],[19.030552336574,99.898487331133],[19.030565014636,99.898636193733],[19.030670242511,99.899114968042],[19.030678452921,99.90036013469],[19.030698737804,99.901545671075],[19.030726629514,99.903041429187],[19.030797626572,99.903089708949],[19.030822982657,99.903167493011],[19.030830589482,99.903266734744],[19.031136564555,99.90351441736],[19.031481406276,99.903696807573],[19.031582830176,99.903771909425],[19.032044308136,99.903321298311],[19.032244619598,99.903010162065],[19.032366327711,99.902704390237],[19.032373267528,99.901608917567],[19.0324569418,99.900769386145],[19.032413836877,99.900723788592],[19.03238594545,99.900643322321],[19.032423979213,99.900514576289],[19.032545687194,99.900503847453],[19.032639503702,99.900562856051],[19.032629361379,99.900688919875],[19.032560900685,99.900772068354],[19.032479762049,99.901560637804],[19.032510189042,99.902668390128],[19.032393552204,99.903030488345],[19.032061390324,99.903400633189],[19.031221983175,99.904248343396],[19.030546920721,99.905411891458],[19.029666432706,99.905980921693],[19.028905236669,99.90631827903],[19.028748027065,99.906664283993],[19.028666886566,99.907214136841],[19.029551822994,99.908667894127],[19.029906810495,99.909236522439],[19.029792707452,99.91067418647],[19.029889061138,99.910990687134],[19.030005699735,99.911097975495],[19.030996723317,99.911190877906],[19.031181822427,99.911381314746],[19.031181822427,99.911633442394],[19.030273360661,99.914413812918],[19.02944928319,99.917551997466],[19.029479710738,99.917742434306],[19.030313930523,99.919080856604],[19.0306220192,99.921207845399],[19.030783018835,99.923265102667]],"start_at":2,"created_at":"2019-12-03 22:59:50","updated_at":"2022-09-13 16:06:14","deleted_at":null,"publish":true,"publish_start":"2019-12-03","publish_end":"2042-12-04","use_is_cal":true,"start_station_code":"","route_type":"in","line_points":"0104000020E610000000010000010100000099B598C311FB5840C2226D38DB073340010100000003457E290DFB58405C8F4B99D907334001010000006ED4638F08FB5840F6FB29FAD70733400101000000D96349F503FB58409168085BD6073340010100000043F32E5BFFFA58402BD5E6BBD40733400101000000AE8214C1FAFA5840C541C51CD307334001010000001912FA26F6FA58405FAEA37DD107334001010000009756DC91F1FA5840F974602DCF0733400101000000A52C2FFEECFA58409D8AFAA9CC0733400101000000B302826AE8FA584041A09426CA0733400101000000C0D8D4D6E3FA5840E5B52EA3C70733400101000000CEAE2743DFFA584089CBC81FC50733400101000000DC847AAFDAFA58402DE1629CC20733400101000000EA5ACD1BD6FA5840D1F6FC18C00733400101000000BD117EAAD1FA58402438E818BC073340010100000067195EBECDFA5840A2D08655B2073340010100000011213ED2C9FA58401F692592A80733400101000000BC281EE6C5FA58409C01C4CE9E07334001010000006630FEF9C1FA58401A9A620B9507334001010000001038DE0DBEFA5840973201488B0733400101000000C1D821E5B9FA5840759143B68307334001010000009FF6D06CB5FA58407743EB018707334001010000003B9858F4B0FA5840897178AA8B0733400101000000D839E07BACFA58409A9F055390073340010100000075DB6703A8FA5840ABCD92FB940733400101000000117DEF8AA3FA5840BCFB1FA4990733400101000000AE1E77129FFA5840CD29AD4C9E07334001010000004BC0FE999AFA5840DE573AF5A20733400101000000E761862196FA5840EF85C79DA7073340010100000084030EA991FA584001B45446AC073340010100000021A595308DFA584012E2E1EEB00733400101000000BD461DB888FA584023106F97B507334001010000000F25734084FA5840FE72994ABA07334001010000004B0467E37FFA58408262735CC0073340010100000086E35A867BFA584007524D6EC60733400101000000C2C24E2977FA58408B412780CC0733400101000000FDA142CC72FA584010310192D207334001010000003981366F6EFA58409420DBA3D8073340010100000075602A126AFA58401910B5B5DE0733400101000000B03F1EB565FA58409DFF8EC7E40733400101000000EC1E125861FA584022EF68D9EA073340010100000027FE05FB5CFA5840A6DE42EBF00733400101000000486A528C58FA5840D9F134CDF507334001010000005B418C3654FA584021D140E2F30733400101000000FCF5F6E951FA58409785B9EFE507334001010000009E319B8151FA58408ED68387D3073340010100000091522FB950FA5840553A775BC1073340010100000075CD7DB44FFA5840779A2955AF0733400101000000BB5B592A4DFA5840B8D6EB1FA10733400101000000E20F23F948FA5840797258279B0733400101000000A141516344FA584043141FB19C0733400101000000C0F299CD3FFA5840645A00F69E0733400101000000DFA3E2373BFA584084A0E13AA10733400101000000FE542BA236FA5840A5E6C27FA307334001010000002A1C771232FA5840353EBBA4A40733400101000000A74D21B02DFA584076E41F0A9F07334001010000006A9F6C1E2AFA5840FCB28D4E9307334001010000002CF1B78C26FA58408381FB9287073340010100000034CF65B522FA5840CE7E31547D07334001010000006DBCDED41EFA58404288C347730733400101000000A7A957F41AFA5840B591553B690733400101000000E096D01317FA5840299BE72E5F073340010100000030DC271113FA584070D1474F5607334001010000005EC247990EFA5840515264005307334001010000005D606E0A0AFA5840FD6E7B035607334001010000006EFBAA8D05FA584042DB82FF5907334001010000006DB53D4D01FA5840DF84063A6107334001010000007F3F168DFEF958402A817CB26F073340010100000081550970FCF95840119F1321800733400101000000836BFC52FAF95840F7BCAA8F90073340010100000034E82008F8F95840BA1D6F9AA007334001010000004747E5B9F5F958403C67D89DB007334001010000005AA6A96BF3F95840BFB041A1C00733400101000000F81632CCF0F95840DABADE69CF0733400101000000449D8FDEECF95840ABF68423D907334001010000009023EDF0E8F958407D322BDDE20733400101000000907B68DEE4F95840C972228EEB073340010100000009AE56F2E0F9584029CCBADAF4073340010100000085BE9D5DDDF958404D5C0760FE07334001010000009001B2C9D8F95840CE306DC5000833400101000000672CCCB8D4F9584096A284ADF8073340010100000016228502D2F95840F3B9F901EA0733400101000000FE0EDB1AD1F958409C2210F4D8073340010100000060ABC4B1CDF95840AD3CE3C5D00733400101000000201D22E8C9F958406B86C757D8073340010100000090B7B44BC5F95840E300C145D9073340010100000076F70AADC0F95840FB84C53BD90733400101000000CF99640EBCF958401C07E529D907334001010000005976CD6FB7F958402EF17FF4D80733400101000000E35236D1B2F9584040DB1ABFD807334001010000006D2F9F32AEF9584052C5B589D80733400101000000F70B0894A9F9584064AF5054D80733400101000000D60370F5A4F958401E478748D80733400101000000EAA6D656A0F9584059F1BF7AD80733400101000000FF493DB89BF95840949BF8ACD8073340010100000014EDA31997F95840CE4531DFD8073340010100000028900A7B92F9584009F06911D907334001010000003D3371DC8DF95840449AA243D90733400101000000675ECF4F89F958403991A22BD70733400101000000BEE043D784F958403C283B84D20733400101000000EFCAF28D80F95840084D64C3CB07334001010000009E0D69F07CF95840B2F23810C20733400101000000A8AB6A8778F9584001EE0F71BD073340010100000017DA408774F958401E2E5933B407334001010000008508178770F958403C6EA2F5AA0733400101000000D93CD5866CF95840C8CE91B8A107334001010000008BC2878668F958403520D27B9807334001010000005FBCBE7964F95840E5366E998F07334001010000007A1F0D6B60F958409AB5DAC5860733400101000000E32106755CF95840CAD547437D07334001010000004C24FF7E58F95840FAF5B4C0730733400101000000B526F88854F958402A16223E6A073340010100000053FC7B5C50F9584061C6F36762073340010100000045D113164CF95840DE546F285F073340010100000020F6CE0149F95840F7C9838C6B07334001010000004C29C3104BF95840559ED39B7A073340010100000090063A514EF958407F7A9CC985073340010100000010D1639E52F9584018D234858C07334001010000006FC8BDA556F95840FDAA6A90950733400101000000228859A55AF958400CB621D09E0733400101000000081FEA9B5EF958404A954C47A80733400101000000405D62C962F9584001F87628B007334001010000004D8557D466F958402539C819B907334001010000005BAD4CDF6AF958404A7A190BC2073340010100000068D541EA6EF958406EBB6AFCCA0733400101000000AC29111A73F958406996BE96D2073340010100000031658D0377F95840A3279742DB0733400101000000B0114A4D7BF95840A91340BBDF073340010100000032F0AE6B7EF95840A6CF368FD30733400101000000641DCFCB82F95840E8B5CCF3D20733400101000000F2DD3A5187F95840525307AED607334001010000008AD4C7D88BF958401B0A5406DA07334001010000004EAC6B7790F9584091508525DA073340010100000013840F1695F958400797B644DA0733400101000000D75BB3B499F958407DDDE763DA07334001010000009B3357539EF95840F2231983DA07334001010000007BE9DEF1A2F95840C23161C7DA07334001010000000A075D90A7F95840D2954F18DB07334001010000009924DB2EACF95840E3F93D69DB0733400101000000284259CDB0F95840F35D2CBADB0733400101000000FBE0D26BB5F95840D46E080FDC0733400101000000D2AD480ABAF9584083333B67DC0733400101000000AA7ABEA8BEF9584032F86DBFDC073340010100000081473447C3F95840E1BCA017DD07334001010000005814AAE5C7F958409181D36FDD07334001010000002D938B0ACCF95840026B7B4AE10733400101000000E8C417F5CFF95840038800A4E80733400101000000F10234DDD2F9584003FCF300F707334001010000003298F01AD5F95840BD4DD11F0708334001010000005E616D34D7F95840CEBA969B1608334001010000005BB12DFAD3F95840CE5749D42308334001010000005801EEBFD0F95840CDF4FB0C31083340010100000037DABE03CDF95840F4F00DC93B08334001010000007A9545F1C8F95840539F5A544408334001010000005BD4DF8DC4F958406275A831490833400101000000EA7A3BEFBFF95840444DA04F4908334001010000007A219750BBF958402525986D49083340010100000009C8F2B1B6F9584006FD8F8B490833400101000000640AAD15B2F95840D4CFBF5C4A0833400101000000C546D77CADF95840086CEB314C0833400101000000278301E4A8F958403C0817074E083340010100000021014A9DA4F95840EE59521A4B083340010100000085A2C3DCA1F958408CD3F3945408334001010000005EE34963A5F95840686FCBBF580833400101000000E94D17BCA9F958404F9E0E7A5408334001010000002EA98B54AEF95840C0F5DB95520833400101000000720400EDB2F95840304DA9B15008334001010000009206EA8AB7F958403F24FC12510833400101000000F74D2229BCF9584061E5DF945108334001010000005C955AC7C0F9584084A6C316520833400101000000B7EA9E64C5F9584026D1017E52083340010100000080CE53CAC9F958404CA295D34C08334001010000009F901D8CCDF95840D0A0F5B3420833400101000000E10754FCD0F9584016E4675C360833400101000000921E8848D4F958403531106C290833400101000000B77CE890D7F95840237F7B6B1C0833400101000000DCDA48D9DAF9584011CDE66A0F08334001010000000239A921DEF95840FF1A526A020833400101000000BA7CECE4E1F95840DD9B32ECF707334001010000001771E3E3E5F95840E24133A6EE07334001010000007465DAE2E9F95840E7E73360E50733400101000000D159D1E1EDF95840EB8D341ADC07334001010000002E4EC8E0F1F95840F03335D4D207334001010000000BC4EF87F4F958401F7646EBC30733400101000000CFDDDD09F7F95840650A1E66B4073340010100000094F7CB8BF9F95840AB9EF5E0A40733400101000000C32CBBEFFBF9584099B5F51A9507334001010000004D7EEDCEFDF958401D310536840733400101000000D8CF1FAEFFF95840A2AC145173073340010100000073EAA71702FA5840AE325D906407334001010000008A4B644C06FA5840AEEF79EB5C0733400101000000361F8AD30AFA5840163193A5590733400101000000BEEA88650FFA5840FB09F6F256073340010100000081FFBA6513FA58408639267B5F07334001010000004402F35717FA584081F1EC1669073340010100000008052B4A1BFA58407DA9B3B2720733400101000000CC07633C1FFA584078617A4E7C0733400101000000900A9B2E23FA5840731941EA850733400101000000540DD32027FA58406ED107868F0733400101000000EF36E80C2BFA5840EDEE9E49990733400101000000467420F82EFA5840E17FCF12A3073340010100000070411A3B33FA5840B1B71E3EA70733400101000000F8970FD637FA58403BACD6C7A5073340010100000081EE04713CFA5840C6A08E51A407334001010000000A45FA0B41FA5840509546DBA20733400101000000939BEFA645FA5840DB89FE64A10733400101000000AC69992F4AFA58403AD6AA90A20733400101000000CFB918554EFA584016C713AFA907334001010000006A3A8EB54FFA58407A9B5566BA07334001010000009B76F02350FA5840EAD158CCCC0733400101000000CBB2529250FA58405A085C32DF07334001010000004F4CAC5851FA5840158AE6EFF00733400101000000CB561AE454FA5840BC8D2B88FB0733400101000000AFF0337259FA5840255305E8F90733400101000000F2A861D65DFA58401E39C22AF4073340010100000035618F3A62FA5840161F7F6DEE07334001010000007919BD9E66FA58400F053CB0E80733400101000000BCD1EA026BFA584007EBF8F2E20733400101000000FF8918676FFA584000D1B535DD0733400101000000434246CB73FA5840F8B67278D7073340010100000086FA732F78FA5840F19C2FBBD10733400101000000C9B2A1937CFA5840E982ECFDCB07334001010000000C6BCFF780FA5840E168A940C607334001010000005023FD5B85FA5840DA4E6683C007334001010000002ACB17D289FA58402FE8B2B9BB07334001010000007B04FA498EFA58402A7E2D08B70733400101000000CC3DDCC192FA58402514A856B207334001010000001D77BE3997FA584020AA22A5AD07334001010000006DB0A0B19BFA58401B409DF3A80733400101000000BEE98229A0FA584016D61742A407334001010000000F2365A1A4FA5840116C92909F0733400101000000605C4719A9FA58400C020DDF9A0733400101000000B1952991ADFA58400798872D96073340010100000002CF0B09B2FA5840022E027C9107334001010000005308EE80B6FA5840FDC37CCA8C0733400101000000EA187802BBFA58403A92A8298B073340010100000081064B1CBFFA58404A355A029307334001010000007ECAF607C3FA584046F8A5C89C07334001010000007C8EA2F3C6FA584042BBF18EA6073340010100000079524EDFCAFA58403E7E3D55B007334001010000007616FACACEFA58403941891BBA073340010100000026909BCBD2FA584040CE95FCC20733400101000000E8030F5ED7FA58402867BBA2C50733400101000000AA7782F0DBFA58400F00E148C807334001010000006BEBF582E0FA5840F79806EFCA07334001010000002D5F6915E5FA5840DE312C95CD0733400101000000EFD2DCA7E9FA5840C6CA513BD00733400101000000B046503AEEFA5840AD6377E1D2073340010100000072BAC3CCF2FA584095FC9C87D50733400101000000ED328D63F7FA5840A3C21C92D70733400101000000DDB89CFEFBFA5840A7D43303D90733400101000000CC3EAC9900FB5840ABE64A74DA0733400101000000BCC4BB3405FB5840AEF861E5DB0733400101000000AB4ACBCF09FB5840B20A7956DD07334001010000009BD0DA6A0EFB5840B51C90C7DE07334001010000008B56EA0513FB5840B92EA738E0073340"},{"id":12,"name":"\u0e2a\u0e32\u0e22 ICT","number":2,"color":"#020af2","line":[[19.030653691418,99.901518511741],[19.030648620186,99.901346850364],[19.030653691408,99.901105451553],[19.030648620186,99.900912332504],[19.030653691408,99.900660204856],[19.030648620186,99.900526094406],[19.03065876263,99.90026860234],[19.030663833851,99.899989652603],[19.030663833851,99.8997804403],[19.030679047515,99.899549770324],[19.03065876263,99.899345922439],[19.030653691408,99.899195718734],[19.030638477742,99.899024057357],[19.030605007679,99.898847031562],[19.030539081764,99.89869146344],[19.030447799684,99.898509073227],[19.030412301083,99.898385691612],[19.030331161397,99.898273038833],[19.030234807968,99.898214030235],[19.030092813339,99.898240852325],[19.029844322447,99.898332047432],[19.02949440607,99.898455429046],[19.029225629222,99.898557352989],[19.028987279578,99.898637819259],[19.028748929592,99.89871828553],[19.028586648555,99.898782658546],[19.028566363414,99.898884582489],[19.028566363414,99.8991259813],[19.028576505985,99.899796533554],[19.028576505985,99.900483179062],[19.028535935699,99.901293206184],[19.028505507977,99.901920843093],[19.028510579265,99.902478742569],[19.02850043669,99.902832794159],[19.028556220843,99.902999091117],[19.028657646529,99.902972269027],[19.028789499827,99.902999091117],[19.029078562461,99.903031277626],[19.029966032318,99.903090286224],[19.030478227049,99.90315465924],[19.030569509113,99.903106379478],[19.030610078903,99.903015184372],[19.030625292571,99.902913260429],[19.030630363794,99.90280060765],[19.030645577461,99.902687954872],[19.030645577461,99.902409005134],[19.030660791126,99.902113962143],[19.030650648683,99.901910114257],[19.030650648683,99.901722359626],[19.030653184293,99.90152119395],[19.030655719904,99.901523876159]],"start_at":11,"created_at":"2022-06-17 21:23:33","updated_at":"2022-09-13 16:36:30","deleted_at":null,"publish":true,"publish_start":"2022-06-01","publish_end":"2042-06-30","use_is_cal":true,"start_station_code":"","route_type":"inside","line_points":"0104000020E61000002E000000010100000060C89DE1ADF958405F12EEBCD8073340010100000069687448A9F9584016804BAAD80733400101000000409D38AFA4F9584004CE16E6D80733400101000000E7C78F16A0F95840E1837DECD80733400101000000EB6D957D9BF958405BC7696FD907334001010000008B1F2CE496F958405E8FC395D907334001010000003FC2BB4C92F958401A82DA8FDA07334001010000003B95ABB78DF9584093E35D18D907334001010000000B01532389F95840BC97F190D707334001010000001EC606C084F9584095FE6F68D2073340010100000091D6239480F95840282650BECA07334001010000009433F3DD7CF95840A3C049EBC00733400101000000A8ECD6327DF9584069716E94AF07334001010000004C7AF7C37EF95840987D3F489E0733400101000000A8C18C4B80F95840AA7A54EE8C073340010100000003DA0FED81F9584065495BBA7B07334001010000002C60A46683F95840AE66284D6A07334001010000009355E8E984F95840263134EE580733400101000000A0C6163688F95840F8A00C2050073340010100000097EA8ACF8CF9584010C5C137500733400101000000EF0DE86891F95840529FFD7E5007334001010000004731450296F95840957939C650073340010100000071E0C29B9AF95840B8A336CA500733400101000000D77D42359FF95840B8A336CA500733400101000000341F06CEA3F95840AA66D954500733400101000000075D0C66A8F95840E9793E694F0733400101000000DA9A12FEACF95840288DA37D4E07334001010000001F522796B1F958401A709F964D0733400101000000BC52452EB6F95840C80F8DB24C073340010100000015DAE1C6BAF958403836F1324C07334001010000008E035560BFF958406110C15D4C0733400101000000FA8A9DF9C3F9584000656B444C0733400101000000A9663D8BC8F95840D83585844C0733400101000000BCCF2769CAF958404D58E4545807334001010000007B80A010CBF958409FA99B866A0733400101000000DA8F3373CBF95840E017F4DA7C0733400101000000B95E52C1CBF95840E30292368F0733400101000000992D710FCCF95840E5ED2F92A107334001010000009987C97BCCF95840E48D32E2B3073340010100000046F99E0ECDF95840987E6D23C60733400101000000C4B1C983CBF958408B93BF25D507334001010000005B7217FDC6F95840949CE4A8D707334001010000007581BA66C2F9584048F67863D80733400101000000310157CEBDF958408973C50FD90733400101000000D9395536B9F958403359B3C8D807334001010000001095F59CB4F9584081A31EC8D8073340"},{"id":13,"name":"\u0e2a\u0e32\u0e22\u0e2b\u0e2d\u0e1e\u0e31\u0e01","number":3,"color":"#fc0303","line":[[19.034507647741,99.884140078304],[19.034506366571,99.884286244527],[19.034508902123,99.884364028589],[19.034501295467,99.884546418802],[19.034483546601,99.88479586424],[19.034456923357,99.884942044651],[19.034432835545,99.885101636068],[19.034371982257,99.885377903596],[19.034313664501,99.885627349035],[19.034202100043,99.886069913522],[19.034035656816,99.886559509357],[19.033934234415,99.886796884855],[19.033736460554,99.887201898416],[19.033483956513,99.887772045378],[19.03328442108,99.888258394836],[19.033207086365,99.888434079776],[19.033129751474,99.888620493383],[19.032985223464,99.888986614583],[19.032944654254,99.889107313989],[19.032942118678,99.889616933702],[19.033035934962,99.890185562013],[19.033129880853,99.890826952863],[19.033156504368,99.89119508605],[19.033137487572,99.891521644998],[19.033096236044,99.89165039103],[19.032989741918,99.891913247514],[19.032898461185,99.892157328534],[19.032781824619,99.892366540837],[19.032578978223,99.892603245783],[19.032389443411,99.892815140536],[19.032203711736,99.893034410882],[19.032116233966,99.893132311562],[19.032046505254,99.893248987603],[19.0318962715,99.893485021997],[19.031842390175,99.893568841056],[19.031794847792,99.893668082762],[19.031711807085,99.893761289525],[19.031628766336,99.893805545974],[19.031492477995,99.893843767452],[19.031406267638,99.893857178497],[19.031314352134,99.893860531259],[19.031221802653,99.893868577893],[19.031127351469,99.893886012244],[19.031032266304,99.893908811021],[19.030961903236,99.893936303679],[19.030890272357,99.893981230664],[19.030818094723,99.894027360476],[19.03074211367,99.894078854667],[19.030601561766,99.894192571746],[19.030305878001,99.894409947042],[19.030053772825,99.894578056023],[19.029799765803,99.894741470649],[19.029644141761,99.894844065234],[19.029491053303,99.89494397743],[19.029467281787,99.894964429282],[19.029453018875,99.894998292173],[19.029428296483,99.895063335731],[19.029369976992,99.895181352928],[19.029367441361,99.895347649886],[19.029375048252,99.895412022903],[19.029400404555,99.895489806965],[19.02952465038,99.895712430312],[19.029797230122,99.896211321086],[19.029689466126,99.896028930977],[19.0299912053,99.896560008362],[19.030077416448,99.896720939547],[19.030171234489,99.896876506623],[19.030268855945,99.897050849269],[19.030396904165,99.897289569214],[19.030493258056,99.897465250335],[19.030551576597,99.897606069877],[19.030625109342,99.897809917762],[19.030754425469,99.897954757049],[19.030789922551,99.898070088776],[19.03075695901,99.898213584946],[19.030710050278,99.898274603872],[19.030651097606,99.898310477696],[19.030575980478,99.898328414652],[19.03052320845,99.898337383263],[19.030456252758,99.898325774418],[19.030382205195,99.898309241347],[19.030309682907,99.898241966424],[19.030263279297,99.898170778343],[19.030235006206,99.898076175949],[19.030220869538,99.897996688485],[19.030201123005,99.897927440634],[19.03014814415,99.897836490485],[19.030091227244,99.897753464741],[19.030047555046,99.897652943506],[19.029909080303,99.897431021742],[19.029763774147,99.897207408587],[19.029640408522,99.897009771742],[19.029481544696,99.89669948323],[19.029342085084,99.896460765135],[19.029253337949,99.896307880714],[19.029181072755,99.896171087331],[19.029033372115,99.895925665038],[19.028934165248,99.895754674414],[19.0289023112,99.895669179243],[19.0288635634,99.895524507747],[19.028818833081,99.895454854254],[19.028796467916,99.895417345317],[19.028723389959,99.895401294067],[19.028672677144,99.895369107559],[19.028589000966,99.895328874424],[19.028492646526,99.895304734542],[19.028308421114,99.895358378723],[19.028241226431,99.895373801455],[19.028175299569,99.895398611902],[19.028052320601,99.895468349292],[19.02771996074,99.895638869806],[19.027610927424,99.89567239743],[19.027382718193,99.895677761837],[19.027266077755,99.89566971521],[19.026748167065,99.895582543173],[19.026226452837,99.895514147087],[19.025906957043,99.89547927837],[19.025729459114,99.895428316398],[19.025701566565,99.89534248571],[19.025683816759,99.895292596626],[19.025557032373,99.895310299202],[19.025539282551,99.895218489366],[19.025628031641,99.89520776053],[19.025678745385,99.895210442739],[19.025722485977,99.895375398593],[19.025751646365,99.895413620072],[19.025838493578,99.895443124371],[19.025935483478,99.895458547073],[19.026164962622,99.895491404133],[19.026287309109,99.89550548573],[19.026596298011,99.895544377761],[19.026730688616,99.895563823776],[19.026896898673,99.895589435616],[19.027112430333,99.895624974885],[19.02730197118,99.895650455871],[19.027407201121,99.895657831946],[19.027575420119,99.895653563671],[19.027623597611,99.895650881462],[19.027658462893,99.89564149373],[19.027717416899,99.895622047715],[19.027838494415,99.895565050773],[19.027906957055,99.895527499847],[19.028023597044,99.895461785726],[19.028064167456,99.895434963636],[19.028135165652,99.895398083262],[19.028199190786,99.895359861783],[19.028311921271,99.895335609958],[19.028389892387,99.895316163942],[19.028476738221,99.89529470627],[19.028535732508,99.89527729337],[19.028583909722,99.895245106862],[19.028604828771,99.895222308085],[19.028712737991,99.895165981696],[19.028805922754,99.895126419113],[19.028879994791,99.89511971359],[19.028931975362,99.895102279232],[19.028972545551,99.895088868187],[19.029007959619,99.895085479527],[19.029071984416,99.895094867259],[19.029115724114,99.895093526154],[19.029157562076,99.895072739035],[19.029213979917,99.895039881974],[19.02924060406,99.895011048227],[19.029347294337,99.894970902927],[19.029425898874,99.894956150777],[19.029479780995,99.894930669791],[19.029605536258,99.894845029757],[19.029665123479,99.894804796622],[19.029789369106,99.894733047531],[19.029876214208,99.894672697828],[19.030011026066,99.894588208244],[19.030071880952,99.894543281243],[19.030226113793,99.894444194618],[19.030291405928,99.894399938169],[19.030383955902,99.894332882943],[19.03051961125,99.894228276792],[19.030603920359,99.894163903775],[19.030729238197,99.89406755041],[19.03081704834,99.894006849903],[19.030869662206,99.893970640081],[19.03096042551,99.893918885532],[19.031013673231,99.893894075098],[19.031158202676,99.89385747269],[19.031253921669,99.893838697227],[19.031291955691,99.893838026675],[19.031359783008,99.893840708884],[19.031450430687,99.893827297839],[19.031542980015,99.893810680727],[19.031604468238,99.893788552503],[19.031656447956,99.893775141458],[19.031698285278,99.893740943293],[19.03175280056,99.893691322426],[19.031789566671,99.893637678246],[19.031806048028,99.893594762901],[19.031833939552,99.893549165348],[19.03185549209,99.893510273317],[19.031904616037,99.893427463448],[19.032024022318,99.893234132628],[19.032076635802,99.893165065746],[19.032130517063,99.893078564505],[19.032219896528,99.892984016638],[19.032407529859,99.892771451573],[19.032617349312,99.892519994478],[19.032662989763,99.892481773],[19.032757440099,99.892353026967],[19.032856327642,99.892182706694],[19.032898164662,99.892111628156],[19.032929225472,99.892019762497],[19.033098475095,99.891594632368],[19.033114322429,99.89153562377],[19.033127000295,99.891442417006],[19.033145383199,99.891284372712],[19.03313777648,99.891129475141],[19.033125098615,99.89091489842],[19.033077020749,99.890579721322],[19.033036451562,99.890322899809],[19.032959072245,99.889815804634],[19.032927377546,99.889626708898],[19.032926743652,99.889483881268],[19.032931143829,99.889105650571],[19.033030031268,99.888806584266],[19.033140328727,99.888525390013],[19.033207521396,99.888360434159],[19.033366303393,99.887998825687],[19.033490546252,99.887702441591],[19.033708604921,99.88720220961],[19.034006533454,99.886577254909],[19.03411935627,99.886266108559],[19.034209368554,99.885971065567],[19.034277828569,99.885684069202],[19.034389392976,99.885198589371],[19.034422355173,99.885016199158],[19.034474334009,99.884581681297],[19.03448067289,99.884401973293],[19.034473066233,99.884222265289],[19.03447053068,99.884113635824],[19.034503492861,99.884102906988],[19.034485079115,99.884181815869]],"start_at":8,"created_at":"2022-06-17 22:05:11","updated_at":"2022-09-13 16:47:44","deleted_at":null,"publish":true,"publish_start":"2022-06-01","publish_end":"2042-06-19","use_is_cal":true,"start_station_code":"","route_type":"inside","line_points":"0104000020E6100000940000000101000000680888549AF85840C7A6716CD50833400101000000AA451EE79EF858408F5DF35DD40833400101000000C3F2166FA3F85840FC283FD7D108334001010000004340D9EEA7F858407DF78373CE0833400101000000AB8F4966ACF85840C8EA4563CA0833400101000000AA8938D9B0F8584068540A07C608334001010000008AB64F4AB5F85840C7DE758CC1083340010100000026940CA1B9F85840287228ADBB0833400101000000EC1C14F3BDF858407454339BB508334001010000008F8C4824C2F85840E28F2A3BAE0833400101000000EE650642C6F85840B03DF030A6083340010100000067D9CC6ACAF85840DCD38A859E0833400101000000416F049BCEF85840CBAC1B1A970833400101000000DED0E3CFD2F85840B38F56DA8F083340010100000037B6CB0CD7F858400AD1E9E58808334001010000001B740B44DBF858405E3344BC810833400101000000A7BAD17DDFF85840AC8642AA7A0833400101000000FD6A92C0E3F85840EB06F1EF730833400101000000D792661EE8F85840A782900A6F083340010100000096C50CB3ECF858407F0D3AF36E0833400101000000A5359241F1F858401ECA7610700833400101000000C9D597C6F5F8584089D4090C7308334001010000003AA8B14CFAF85840A004E6EB750833400101000000DC32FAD4FEF85840BCFCB193780833400101000000F2F95F5D03F95840F3804F377B0833400101000000CFE4FBEE07F95840EA18A8897C08334001010000003CA155810CF95840CB421B357C08334001010000001456B3F610F95840BB10CDBA7808334001010000008DFAD43515F958402AD056DC710833400101000000CBC35F7919F9584060CA3F366B083340010100000004EE1F5A1DF9584091E45E95610833400101000000636D95D220F958400DE016A055083340010100000057DEC33E24F95840AC23C672490833400101000000017F06BC27F958401854EF933D08334001010000000EFF7E742BF9584035F8F204330833400101000000906C6E512FF95840EB6D2C2C290833400101000000F864ED1E33F958406DE2D4341F0833400101000000988FE5CA34F95840C43EA4710E083340010100000027383F3B35F9584047591E3BFC07334001010000003F9DCF9936F95840E1D3AEE5EA073340010100000056027F2E39F958405AE6B4C7DB0733400101000000F1CA08F83BF95840A19CE53ECD0733400101000000593AC4A33EF95840422D325DBE0733400101000000D7B4B82B41F95840BE95BB17AF0733400101000000E4DA18A743F95840EAF94BB19F07334001010000002E16A72A46F95840D0972260900733400101000000084D3BD349F958404BE3806C860733400101000000635BBF4D4EF9584022192D108507334001010000006B5C436C52F9584076C233DA8C07334001010000003898287056F9584027FDD0AB9507334001010000008DE63C755AF9584042EBDA749E0733400101000000CA3570A158F95840D18E9EF29907334001010000008BAF5F6D5CF95840502A5891A20733400101000000142EF66860F958401790849EAB073340010100000065FA9D6B64F9584080BD9177B40733400101000000CB03186168F958408B9009AEBD073340010100000090882D686CF95840FA080E68C607334001010000006CA4457270F9584031DF4E07CF073340010100000062A863B874F958406450A59BD507334001010000004B6C356A78F958406E24CCEBDF07334001010000009D2281C07CF95840D4B30C65DE0733400101000000EFF4D5427EF95840E9171018CE073340010100000094C4A3CE7BF958405774D2CBBF07334001010000005826936D77F95840768E6CC2BA0733400101000000CCC1167573F95840F90AEDBCB1073340010100000038EF3B8C6FF958405BF35537A8073340010100000002E167B46BF95840574BD73E9E0733400101000000226DACC767F9584020D95ED19407334001010000005731DDB363F958400D75B3778C07334001010000002132F5BD5FF95840A710944383073340010100000001763AC05BF95840DC2842477A0733400101000000DABB79CC57F958407E9B3B0671073340010100000080853ED453F9584098DC84E867073340010100000042FB558C4FF95840917C40BD610733400101000000C3526E394DF95840E41335E8520733400101000000B287D2654DF958401289D255410733400101000000EDB985124FF95840410B6A6B300733400101000000AB6A312F51F95840CDAA9429200733400101000000EE79F1B552F9584028B3CE190F073340010100000002C264AF52F95840A92F8BCBFC0633400101000000F39781F851F95840D67D63B4EA0633400101000000728DA43651F95840C94955A2D806334001010000008E5C369E50F95840D8907977C60633400101000000E91D380950F95840E41AF74AB406334001010000003576FE894FF95840CB7EFF13A206334001010000002004AC464DF95840E3FD2F5B940633400101000000D74E6C3F4BF9584097C690238A063340010100000064779F6E4DF9584030F8855395063340010100000074D9203B4FF95840289EF0C5A40633400101000000E319F6D94FF95840B2AB0CEDB6063340010100000025D6CC6950F9584088643D1CC906334001010000004A2CC60C51F9584067D61D41DB0633400101000000053489C651F9584082097B58ED06334001010000005208596052F9584061390A81FF06334001010000001E92F85952F95840CD82D2CE11073340010100000067C183A050F958405FCDA5B0220733400101000000EEB5795D4EF95840B03A8B9C3207334001010000004E5293E84CF95840ECD25AC8430733400101000000B21C1D1D4BF9584017698E3E540733400101000000D18C2D9749F9584040952749650733400101000000F5FD00DD48F95840498A97ED76073340010100000016A3010447F9584064CD9C4D870733400101000000DD1CDFAE44F958403047E3F09607334001010000008685913E42F958402CDD176FA60733400101000000BF9CC2B93FF958409339F5B9B507334001010000003EB66D2B3DF95840474D08EDC40733400101000000A04EC0643AF958401998D27FD3073340010100000062072CA837F95840622FE12FE20733400101000000D707EF7435F95840592C9D26F20733400101000000AF8ED7A734F95840BA40FD1A040833400101000000A2AC52EF33F958404EE64F15160833400101000000D1BC432331F95840B8C4B7B32308334001010000006199F2292DF958404B920CC22C08334001010000006EB58C5829F958403DCD35D9360833400101000000E28FAFD325F95840912D4778420833400101000000D252BE5F22F958407FCA18824E0833400101000000D6DA5AE31EF958407194535F5A083340010100000095BFDE3D1BF9584029DDFB466508334001010000004517962E17F95840F292689A6D083340010100000088E075EB12F95840D843AF4F7408334001010000002AB9939B0EF95840467196597A08334001010000007C2A7A0E0AF95840E971B5117C0833400101000000C9B79B7B05F958400C744A0F7B0833400101000000FA6F3FF100F958405062B4B37808334001010000003961066AFCF858400AAC48F0750833400101000000EA7D10E3F7F85840C6C2612573083340010100000084C2D15BF3F858408952CF61700833400101000000E8640CD4EEF85840D2B304EA6D08334001010000005804713FEAF858406F3B7F076E0833400101000000550377BDE5F85840CB9DB9FB6F083340010100000050482868E1F8584060ED61E9750833400101000000796B1425DDF8584098234DA07C0833400101000000E48DD8ECD8F85840C8D785C08308334001010000007756AFBAD4F85840AD66361A8B08334001010000000D153381D0F858403E9EA02F920833400101000000B5D0A14DCCF85840002C697C99083340010100000039B6A91AC8F85840E8BBCACEA00833400101000000A67D69F7C3F85840D51701ABA8083340010100000011C8E0D4BFF8584032A3808DB00833400101000000CF9B459DBBF85840999098A6B708334001010000007AFC2749B7F8584056E65BA1BD08334001010000006D21DBE3B2F8584043B000C4C20833400101000000C80EE46EAEF8584014572AFFC60833400101000000431904F8A9F858400BEAB419CB08334001010000001900317DA5F85840D6D33BE7CE0833400101000000D8D504F4A0F85840020D6B69D10833400101000000244AB0669CF8584003B47B64D308334001010000001DB1E8D297F85840E5BC8E59D3083340"}]

        for (var i = 0; i < routes.length; i++) {
          var route = routes[i]
          var line = []
          var bound = new google.maps.LatLngBounds()
          for (var l = 0; l < route.line.length; l++) {
            var point = route.line[l]
            line.push({
              lat: point[0],
              lng: point[1]
            })
            bound.extend({
              lat: point[0],
              lng: point[1]
            })
          }
          polylineBounds[route.number] = bound
          var polyline = new google.maps.Polyline({
            title: line.name,
            path: line,
            // geodesic: true,
            strokeColor: route.color,
            strokeOpacity: 0.9,
            strokeWeight: 4,
            map: route.number == currentRoute ? map : null
          })
          polylines[route.number] = polyline
        }

        if (polylineBounds[currentRoute])
          map.fitBounds(polylineBounds[currentRoute])

        // start MQTT subscription
        var mqttServer = 'ws://bustransit.up.ac.th/mqtt'
        console.log('try connect to mqtt')
        mqttClient = mqtt.connect(mqttServer)

        mqttClient.on('connect', function () {
          console.log('mqtt connected')
          mqttClient.subscribe('transit/#')
        })

        var routeColor = {
                                1:[0,209,14],
                                2:[2,10,242],
                                3:[252,3,3],
                          }

        for (var i = 0; i < stations.length; i++) {
          var station = stations[i]
          var s = new google.maps.Marker({
            position: { lat: station[2], lng: station[3] },
            map: station[4].indexOf(currentRoute) >= 0 ? map : null,
            title: station[1],
            icon: {
              url: 'http://bustransit.up.ac.th/assets/station_marker.png',
              anchor: new google.maps.Point(8, 8)
            }
          })
          s['station_id'] = station[0]
          s['station_name'] = station[1]
          stations[i][5] = s
          google.maps.event.addListener(s, 'click', function (e) {
            busToStation = []
            comingBus = null
            displayEstimateArrivalTime(this.station_id, e.latLng, this.station_name)
          })
                    }

        mqttClient.on('message', function (topic, message) {
          // message is Buffer
          if (topic == 'transit/busonservice') {
            var d = JSON.parse(message.toString())
            if(d.route==0){
              return
            }
            // check if pin exist
            var ll = new google.maps.LatLng(d.lat, d.lng)
            var m = markers[d.route + '-' + d.bus + '-' + d.driver]
            if (!polylines[d.route]) {
              return
            }
            if (!m) {
              markers[d.route + '-' + d.bus + '-' + d.driver] = {
                data: d,
                coming: d.bus == comingBus,
                lastupdate: Date.now(),
                marker: new google.maps.Marker({
                  position: ll,
                  map: polylines[d.route] ? polylines[d.route].map : map,
                  title: 'bus:' + d.bus + ' route:' + d.route,
                  icon: {
                    url: 'http://bustransit.up.ac.th/assets/bus_marker?color=' + routeColor[d.route] + '&bus=' + d.bus + '&density=' + d.density,
                    // anchor: (d.bus == comingBus ? new google.maps.Point(31, 70) : new google.maps.Point(15, 15))
                    anchor: new google.maps.Point(31, 70)
                  }
                })
              }
            } else {
              m.lastupdate = Date.now()
              m.marker.setPosition(ll)
              if (m.data.route != d.route
                || m.data.passenger != d.passenger
                || m.coming && d.bus != comingBus
                || !m.coming && d.bus == comingBus
              ) {
                m.marker.setIcon({
                  url: 'http://bustransit.up.ac.th/assets/bus_marker?color=' + routeColor[d.route] + '&bus=' + d.bus + '&density=' + d.density,
                  // anchor: (d.bus == comingBus ? new google.maps.Point(31, 70) : new google.maps.Point(15, 15))
                  anchor: new google.maps.Point(31, 70)
                })
                m.coming = d.bus == comingBus
              }
              m.data = d
            }
          } else if (topic == currentEstimateTimeTopic) {
            // add to bus update pool
            var data = JSON.parse(message.toString())
            busToStation[data.bus] = [data.t, Date.now()]
          }
        })

        setInterval(function () {
          // check marker update
          var now = Date.now()
          for (var k in markers) {
            if (now - markers[k].lastupdate > 5000) {
              // remove from list
              markers[k].marker.setMap(null)
              delete markers[k]
            }
          }

          // calculate nearest bus from station
          var firstArrive = null
          var e = 999999
          for (var busId in busToStation) {
            var b = busToStation[busId]
            if (now - b[1] > 5000) {
              // remove from list
              delete busToStation[busId]
              continue
            }
            if (b[0] < e) {
              firstArrive = busId
              e = busToStation[busId][0]
            }
          }
          if (firstArrive !== null) {
            // display estimate time
            $('#estimate_time').show()
            $("#estimate_status").html("")
            document.getElementById('estimate_time_value').innerHTML = formatEstimateTime(e)
            document.getElementById('estimate_bus').innerHTML = 'no.' + firstArrive
            comingBus = firstArrive
          } else {
            $('#estimate_time').hide()
            $("#estimate_status").html("รถยังไม่ออกจากสถานีจอด")
            document.getElementById('estimate_bus').innerHTML = ''
            comingBus = null
          }
        }, 2000)

        // ==================== LOCATION ===============================
        geolocator.config({
          language: 'en',
          // google: {
          //   version: "3",
          //   key: "YOUR-GOOGLE-API-KEY"
          // }
        })
        var locationMarker
        var locationRadius

        window.onload = function () {
          var options = {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumWait: 10000,     // max wait time for desired accuracy
            maximumAge: 0,          // disable cache
            desiredAccuracy: 30,    // meters
            // fallbackToIP: true,     // fallback to IP if Geolocation fails or rejected
            // addressLookup: true,    // requires Google API key if true
            // timezone: true,         // requires Google API key if true
            // map: "map-canvas",      // interactive map element id (or options object)
            // staticMap: true         // map image URL (boolean or options object)
          }
          geolocator.watch(options, function (err, position) {
            if (err) {
              // alert(err.message)
              return console.log(err)
            }
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            }
            if (locationMarker)
              locationMarker.setPosition(pos)
            else {
              locationMarker = new google.maps.Marker({
                position: pos,
                map: map,
                title: 'My Location',
                icon: 'http://bustransit.up.ac.th/assets/current_station.png'
              })
            }
            if (locationRadius)
              locationRadius.setCenter(pos)
            else {
              locationRadius = new google.maps.Circle({
                map: map,
                center: pos,
                radius: position.coords.accuracy,
                strokeWeight: 1,
                strokeColor: '#039be5',
                strokeOpacity: 0.4,
                fillColor: '#039be5',
                fillOpacity: 0.1
              })
            }
          })
        }
      }

      function formatEstimateTime (second) {
        var d = new Date(Date.now() + (second * 1000))
        var h = d.getHours()
        var m = d.getMinutes()
        if (h < 10)
          h = '0' + h
        if (m < 10)
          m = '0' + m
        return h + ':' + m
//        var minute = Math.floor(second / 60)
//        if (minute < 10) {
//          minute = '0' + minute
//        }
//        var second = second % 60
//        if (second < 10) {
//          second = '0' + second
//        }
//        if (minute < 1) {
//          return '00:' + second
//        } else {
//          return minute + ':' + second
//        }
      }

      function handleLocationError (hasNavigator) {
//        $('#error').html('Could not find your location').fadeIn()
//          .click(function () {
//            $('#error').fadeOut(300)
//          })
//        setTimeout(function () {
//          $('#error').fadeOut(300)
//        }, 5000)
      }

      function setBusVisibility (route, visible) {
        for (var b in markers) {
          var marker = markers[b]
          if (marker.data.route == route) {
            marker.marker.setMap(visible ? map : null)
          }
        }
      }

      function setStationVisibility (route) {
        for (var i = 0; i < stations.length; i++) {
          var s = stations[i]
          if (s[4].indexOf(route) >= 0) {
            s[5].setMap(map)
          } else {
            s[5].setMap(null)
          }
        }
      }

      function toggleRoute (route, routeName) {

        if (currentRoute == route) {
          return
        }
        $("#estimate").hide()
        if (polylines[currentRoute])
          polylines[currentRoute].setMap(null)
        if (polylines[route]) {
          polylines[route].setMap(map)
          map.fitBounds(polylineBounds[route])
        }
        $('.route_' + currentRoute).removeClass('active')
        $('#estimate_box_top').removeClass('bgcolor_' + currentRoute)
        setBusVisibility(currentRoute, false)
        currentRoute = route
        $('.route_' + currentRoute).addClass('active')
        $('#estimate_box_top').addClass('bgcolor_' + currentRoute)
        setBusVisibility(currentRoute, true)
        setStationVisibility(currentRoute)

        $('#estimate_route_label').html(routeName)

        // disable station selection
        clearEstimate()
      }

      function clearEstimate () {
        if (currentStationMarker != null)
          currentStationMarker.setMap(null)
        if (mqttClient != null && currentEstimateTimeTopic != null)
          mqttClient.unsubscribe(currentEstimateTimeTopic)
        document.getElementById('estimate_time_value').innerHTML = ''
        document.getElementById('estimate_station_name').innerHTML = ''
        document.getElementById('estimate_bus').innerHTML = ''
        $('#estimate_time').hide()
      }

      function displayEstimateArrivalTime (stationId, ll, stationName) {
        $("#estimate").show()
        $('#estimate_time').hide()
        document.getElementById('estimate_bus').innerHTML = ''
        if (currentStationMarker == null) {
          currentStationMarker = new google.maps.Marker({
            position: ll,
            map: map,
            title: 'ตำแหน่งปัจจุบัน',
            icon: 'http://bustransit.up.ac.th/assets/current_station.png'
          })
        } else {
          currentStationMarker.setMap(map)
          currentStationMarker.setPosition(ll)
        }
//        document.getElementById('estimate_station_name').innerHTML = stationName

        // sub to mqtt estimation time
        if (currentEstimateTimeTopic != null)
          mqttClient.unsubscribe(currentEstimateTimeTopic)
        currentEstimateTimeTopic = 'e/r/' + currentRoute + '/' + stationId
        mqttClient.subscribe(currentEstimateTimeTopic)
        document.getElementById('estimate_time_value').innerHTML = ''
        document.getElementById('estimate_station_name').innerHTML = ''
        $('#estimate_status').html('กำลังตรวจสอบ')
        $.get('//' + window.location.host + '/api/estimate/value?route=' + currentRoute + '&station=' + stationId, function (res) {
          document.getElementById('estimate_station_name').innerHTML = 'สถานีถัดไป "' + res.next + '"'
          if (res.t >= 0) {
            $('#estimate_status').html('')
            document.getElementById('estimate_time_value').innerHTML = formatEstimateTime(res.t)
            document.getElementById('estimate_bus').innerHTML = res.bus ? 'no.' + res.bus : ''
            comingBus = res.bus
            busToStation[res.bus] = [res.t, Date.now()]
            $('#estimate_time').show()
          } else {
            $('#estimate_status').html('รถยังไม่ออกจากสถานีจอด')
            document.getElementById('estimate_time_value').innerHTML = ''
            document.getElementById('estimate_bus').innerHTML = ''
            $('#estimate_time').hide()
          }
        }, 'json')

      }

      $(function () {
        var buttonBox = $('#route_button_box')
        var mapLegend = $('#map_legend')

        function calculateSize () {
          var boxWidth = Math.min($('body').width(), 405)
          var w = (boxWidth - 10) / buttonBox.children().length
          mapLegend.css({ width: boxWidth })
          var h = Math.min(w, 60)
          buttonBox.children().each(function () {
            $(this).css({ width: w, height: h, lineHeight: (h / 2) + 'px' })
          })
        }

        $(window).resize(calculateSize)
        calculateSize()
      })
    </script>
</head>
<body>
<style>
    @font-face {
        src: url(http://bustransit.up.ac.th/fonts/Prompt-Medium.ttf);
        font-family: 'prompt';

    }

    html, body, a {
        font-family: 'prompt', 'sans-serif';
    }

    #route_button_box_container {
        position: fixed;
        bottom: 0;
        width: 100%;
        text-align: center;
        z-index: 100;
        padding: 0 0px 30px 0px;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
    }

    #route_button_box {
        display: inline-block;
        margin-top: 5px;
        -webkit-border-radius: 3px;
        -moz-border-radius: 3px;
        border-radius: 3px;
        background: rgba(255, 255, 255, 1);
        -webkit-box-shadow: 0 1px 6px -3px #000;
        -moz-box-shadow: 0 1px 6px -3px #000;
        box-shadow: 0 1px 6px -3px #000;
        font-size: 0;
    }

    .route_button {
        font-size: 20px;
        height: 50px;
        width: 40px;
        line-height: 40px;
        cursor: pointer;
        text-align: center;
        display: inline-block;
        color: rgb(130, 76, 182);
        background: rgba(255, 255, 255, 0.6)
    }

    .route_button:first-child {
        -webkit-border-radius: 3px 0 0 3px;
        -moz-border-radius: 3px 0 0 3px;
        border-radius: 3px 0 0 3px;
    }

    .route_button:last-child {
        -webkit-border-radius: 0 3px 3px 0px;
        -moz-border-radius: 0 3px 3px 0px;
        border-radius: 0 3px 3px 0px;
    }

    .route_1 {
        margin-left: 0px;
    }

        .route_1.active {
        background: rgb(0,209,14) !important;
        color: white !important;
    }

    .route_1                                                                                                                                                                                                                                 {
        color: rgb(0,209,14)
    }

    .color_1                                                                                                                                                                                                                                 {
        color: rgb(0,209,14)
    }

    .bgcolor_1                                                                                                                                                                                                                                 {
        background: rgb(0,209,14)
    }

        .route_2.active {
        background: rgb(2,10,242) !important;
        color: white !important;
    }

    .route_2                                                                                                                                                                                                                                 {
        color: rgb(2,10,242)
    }

    .color_2                                                                                                                                                                                                                                 {
        color: rgb(2,10,242)
    }

    .bgcolor_2                                                                                                                                                                                                                                 {
        background: rgb(2,10,242)
    }

        .route_3.active {
        background: rgb(252,3,3) !important;
        color: white !important;
    }

    .route_3                                                                                                                                                                                                                                 {
        color: rgb(252,3,3)
    }

    .color_3                                                                                                                                                                                                                                 {
        color: rgb(252,3,3)
    }

    .bgcolor_3                                                                                                                                                                                                                                 {
        background: rgb(252,3,3)
    }

    
    #estimate {
        display: none;
        position: fixed;
        z-index: 100;
        top: 0;
        left: 0;
        padding: 10px;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        color: white;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        width: 100%;
        text-align: center;
        text-align: center;
    }

    #estimate_box {
        width: 100%;
        background: #fff;
        display: inline-block;
        -webkit-box-shadow: 0 1px 6px -3px #000;
        -moz-box-shadow: 0 1px 6px -3px #000;
        box-shadow: 0 1px 6px -3px #000;
        position: relative;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        font-size: 0;
        -webkit-border-radius: 3px;
        -moz-border-radius: 3px;
        border-radius: 3px;
    }

    #estimate_box_top {
        height: 60px;
        position: relative;
        border-radius: 3px 3px 0 0;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.6);
    }

    @media (min-width: 425px) {

        #estimate_box {
            width: 405px;
        }
    }

    #estimate_route {
        position: absolute;
        font-size: 20px;
        width: 80px;
        height: 48px;
        font-weight: bold;
        top: 7px;
        line-height: 24px;
        border-right: 1px solid #eee;
    }

    #estimate_station_name {
        font-size: 12px;
        color: #000;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        bottom: 6px;
        left: 80px;
        right: 10px;
        text-align: center;
        border-top: 1px solid #eee;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        height: 28px;
        line-height: 28px;
        padding: 0 10px;
    }

    #estimate_status {
        position: absolute;
        left: 80px;
        font-size: 20px;
        text-align: center;
        right: 0;
        top: 0;
        bottom: 0;
        line-height: 60px;
    }

    #estimate_time {
        position: absolute;
        right: 0;
        top: 0;
        left: 80px;
        bottom: 0;
        font-size: 27px;
    }

    #estimate_time_value {
        display: inline-block;
        font-size: 39px;
        width: 110px;
    }

    @media (max-width: 375px) {

        #estimate_time {
            font-size: 20px;
            top: 5px;
        }

        #estimate_time_value {
            display: inline-block;
            font-size: 33px;
            width: 88px;
        }
    }

    #map_legend {
        margin: 0 auto;
        text-align: left;
        font-size: 0;
    }

    #map_legend > div {
        font-size: 16px;
        display: inline-block;
        width: 33%;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
    }

    #map_legend > div > div {
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
        border-radius: 3px;
        text-align: center;
        box-shadow: 0 0 5px -3px #000000;
        background: white;
        margin: 5px;
        padding: 8px 0;
    }

    #map_legend > div > div.button {
        cursor: pointer;
        -webkit-box-shadow: 0 1px 6px -3px #000;
        -moz-box-shadow: 0 1px 6px -3px #000;
        box-shadow: 0 1px 6px -3px #000;
    }

    #map_legend > div > div img {
        width: 22px;
        vertical-align: middle;
    }

    #map_legend .empty_seat_legend {
        border: 2px solid #808080;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        -webkit-border-radius: 20px;
        -moz-border-radius: 20px;
        border-radius: 20px;
    }

    @media (max-width: 375px) {
        #map_legend > div > div span {
            margin-left: 5px !important;
        }
    }

    @media (max-width: 345px) {

        #map_legend > div > div img {
            width: 15px;
        }

        #map_legend > div > div span {
            margin: 0 !important;
        }
    }

    #map_legend img {
        vertical-align: middle;
    }

    #map_legend span {
        display: inline-block;
    }

    #maintenance_message {
        z-index: 2000;
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
    }

    #maintenance_message #message {
        width: 330px;
        margin: 0 auto;
        text-align: center;
        background: #fff;
        margin-top: 200px;
        padding: 10px;
        -webkit-border-radius: 3px;
        -moz-border-radius: 3px;
        border-radius: 3px;
        -webkit-box-shadow: 0px 0px 3px #000;
        -moz-box-shadow: 0px 0px 3px #000;
        box-shadow: 0px 0px 3px #000;
    }
</style>
<div id='map'>
    <div id="route_button_box_container">
        <div id="map_legend">
            <div>
                <div class="empty_seat_legend" style="display:none;">
                    <img src="http://bustransit.up.ac.th/assets/seat.png"/>
                    <span style="margin-left:10px;">ที่นั่งว่าง</span>
                </div>
            </div>
        </div>
        <div id="route_button_box">
                            <a onclick="toggleRoute(1,'1')" class="route_button active route_1 has-text-centered">
                    1<br/>สายวิศวะ
                </a>
                            <a onclick="toggleRoute(2,'2')" class="route_button  route_2 has-text-centered">
                    2<br/>สาย ICT
                </a>
                            <a onclick="toggleRoute(3,'3')" class="route_button  route_3 has-text-centered">
                    3<br/>สายหอพัก
                </a>
                    </div>
    </div>
    <div id="realmap">

    </div>
    <div id="error"></div>
    <div id="estimate">
        <div id="estimate_box">
            <div id="estimate_box_top" class="bgcolor_1">
                <div id="estimate_route"><span id="estimate_route_label">สาย1</span><br/><span id="estimate_bus"></span></div>
                <div id="estimate_time" style="display: none;">
                    <span id="estimate_station_label">จะมาถึงเวลา</span>
                    <span id="estimate_time_value">&nbsp;</span>
                    <span id="estimate_time_label"> น.</span>
                </div>
                <div id="estimate_status">กำลังตรวจสอบ</div>
            </div>
            <div id="estimate_station_name"></div>

        </div>
    </div>
</div>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4te4P5ELSzfmdWkRTQHTHTgkpUvrW6aQ&callback=initMap" async defer></script>
</body>
</html>
